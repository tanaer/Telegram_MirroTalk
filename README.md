# Telegram MirroTalk Bot

 [English](README_EN.md) | [中文](README.md)

基于 Cloudflare Workers 的 Telegram 消息转发机器人，集成防骚扰和反诈骗功能。

## 功能特点

- **无服务器架构**：运行在 Cloudflare Workers 上，低成本且高可用。
- **消息转发**：将用户发送给机器人的消息转发给管理员。
- **运行模式**：
  - **私聊模式**：一对一转发，轻量简单。
  - **话题群组模式**：为每个用户创建独立话题，支持高并发管理。
- **防骚扰与反诈骗**：
  - **关键词过滤**：自动丢弃包含黑名单关键词（如 '刷单', '兼职', 'USDT'）的消息。
  - **动态算术验证**：未验证用户需完成随机数学题（如 3+5=?）才允许发送媒体，有效拦截脚本攻击。
  - **多级安全策略**：支持严格（禁言）、标准（禁图）、宽松（免验证）三种安全级别动态切换。
  - **消息去重**：防止 7 天内的重复消息刷屏。
  - **屏蔽/信任系统**：支持暗屏蔽 (`/block`) 和永久信任 (`/trust`) 用户。
- **管理功能**：
  - **全员广播**：回复一条消息并发送 `/broadcast` 即可全员广播（保留原格式/媒体）。
  - **可视化菜单**：提供 `/admin` 管理面板，快捷操作。
  - **服务消息过滤**：自动忽略进群/退群等系统消息干扰。

## 部署到 Cloudflare Workers

<a href="https://deploy.workers.cloudflare.com/?url=https://github.com/tanaer/Telegram_MirroTalk">
  <img src="https://camo.githubusercontent.com/aa3de9a0130879a84691a2286f5302105d5f3554c5d0af4e3f2f24174eeeea25/68747470733a2f2f6465706c6f792e776f726b6572732e636c6f7564666c6172652e636f6d2f627574746f6e" alt="Deploy to Cloudflare Workers" />
</a>

### 配置

需要以下环境变量（可以在 `wrangler.toml` 中填写或在部署时配置）：

- `ENV_BOT_TOKEN`: 你的 Telegram 机器人 Token (从 @BotFather 获取)。
- `ENV_BOT_SECRET`: 用于 Webhook 安全验证的随机字符串 (例如 UUID)。
- `ENV_ADMIN_UID`: 你的 Telegram 用户 ID (从 @userinfobot 获取)。用于接收通知。
- `ENV_SUPERGROUP_ID`: 你的超级群组 ID (以 `-100` 开头)。仅在 `ENV_ENABLE_TOPIC_GROUP` 为 `true` 时需要。
- `ENV_ENABLE_TOPIC_GROUP` (可选): 设置为 `true` 以开启话题群组模式。默认为 `false` (私聊模式)。
- `ENV_MAP_TTL_DAYS` (可选): 消息映射过期时间（天）。默认为 7 天。

**KV 命名空间**：
你需要创建一个名为 `MirroTalk` 的 KV 命名空间并将其绑定到 Worker。

## 运行模式

### 1. 私聊模式 (默认)
机器人直接将用户消息转发到管理员的私聊 (`ENV_ADMIN_UID`) 中。
- **设置**：只需配置 `ENV_BOT_TOKEN`, `ENV_BOT_SECRET`, 和 `ENV_ADMIN_UID`。
- **使用**：直接回复转发来的消息即可回复用户。

### 2. 话题群组模式 (推荐用于高并发)
机器人会在一个超级群组中为每个用户创建一个独立的 **Forum Topic (话题)**。这样可以井井有条地管理大量对话。

**设置步骤：**
1.  **环境变量**：
    - 设置 `ENV_ENABLE_TOPIC_GROUP` 为 `true`。
    - 设置 `ENV_SUPERGROUP_ID` 为你的群组 ID (如 `-100xxxxxxx`)。

2.  **Telegram 群组设置**：
    - 创建一个新的群组（或使用现有群组）。
    - 将机器人拉入群组并设为**管理员**。
    - **关键**：机器人必须拥有 **"Manage Topics/管理话题"** 权限。
    - 在群设置中开启 **Topics (话题)** 功能：
      - 群组信息 -> 编辑 -> 话题 -> 开启。
      - *注：这会将群组转换为超级群组。*

3.  **获取群组 ID**：
    - 将 `@username_to_id_bot` 拉入群组，它会告诉你 ID。
    - 或者在网页版打开群组，URL 中包含 ID (例如 `#/-100123456789`)。

## 防骚扰功能详解

本机器人包含一套强大的防骚扰系统，旨在保护管理员免受垃圾信息和诈骗的侵扰：

1.  **关键词黑名单**：
    - 包含可疑关键词（如“兼职”、“刷单”、“USDT”、“色情”等）的消息会被静默丢弃。

2.  **动态算术验证**：
    - 未验证用户必须通过一道动态生成的数学题（如 `3 + 5 = ?`）来证明自己是真人。
    - 题目动态生成，无法被简单脚本破解。

3.  **多级安全策略**：
    - 管理员可通过 `/admin` 菜单切换安全级别：
      - **Strict (严格)**：未验证用户禁言。
      - **Standard (标准)**：未验证用户可发纯文本，禁止发媒体（默认）。
      - **Relaxed (宽松)**：无需验证。

4.  **暗屏蔽 (Shadowban)**：
    - 管理员可以使用 `/block` 指令对用户进行暗屏蔽。
    - 用户不会知道自己被屏蔽了，但他们的消息将不再被转发。

## 管理员指令

在超级群组中发送 `/admin` 查看控制面板：

- **/info**：查看当前话题对应的用户信息。
- **/trust**：永久信任当前用户（跳过验证）。
- **/block**：屏蔽当前用户。
- **/unblock**：解除屏蔽。
- **/broadcast**：回复一条消息进行全员广播。
- **/security <1|2|3>**：设置安全级别。
   103→
### 权限系统深入理解 (/trust vs /block vs /unblock)

为了在安全与便利之间取得平衡，机器人设计了一套精细的权限控制逻辑：

*   **`/block` (暗屏蔽/黑名单)**：
    - **作用**：将用户加入黑名单并清除其信任/验证状态。
    - **效果**：用户发送的所有消息将被静默丢弃，管理员不会收到任何提醒。
*   **`/unblock` (解除屏蔽)**：
    - **作用**：仅将用户从黑名单中移除。
    - **效果**：用户恢复到**普通状态**。如果系统处于严格/标准模式，该用户发送消息仍需接受关键词过滤和算术验证。
*   **`/trust` (永久信任/白名单)**：
    - **作用**：设置用户为永久信任状态，并**自动执行解除屏蔽**。
    - **效果**：用户成为 **VIP/白名单** 成员。他将跳过所有安全检查（免验证、免关键词过滤、免去重），在任何模式（包括严格模式）下都能自由通行。

**优先级规则**：`trust` 具有最高优先级且与 `block` 状态互斥。执行 `/trust` 会自动覆盖并移除该用户的 `/block` 状态。

## Cloudflare 免费版限制与应对

Cloudflare Workers KV 免费套餐有以下主要限制：
1.  **存储空间**：1GB
2.  **写入操作**：每天 1000 次

本系统已针对这些限制进行了深度优化：
- **自动过期 (TTL)**：所有的消息映射记录都会在 7 天（默认）后自动删除。这确保了 KV 空间永远不会被无限占满。您可以通过 `ENV_MAP_TTL_DAYS` 环境变量调整此时间。
- **空间回收**：解除屏蔽 (`/unblock`) 和移除信任 (`/untrust`) 操作会直接从 KV 中**删除**数据，而不是标记为无效，从而释放空间。
- **写入节省**：通过消息去重和黑名单过滤，无效的垃圾消息不会触发 KV 写入操作，节省宝贵的每日写入额度。

**注意**：如果您的机器人每天需要处理超过 1000 条有效交互（转发+回复），建议升级 Cloudflare Workers 付费套餐（$5/月）。

## 安装指南

1.  **获取 Token**：从 @BotFather 获取你的 Bot Token。
2.  **获取 UID**：从 @username_to_id_bot 或类似机器人获取你的用户 ID。
3.  **部署**：点击上方的 "Deploy with Workers" 按钮。
4.  **绑定 KV**：在 Cloudflare 控制台，进入你的 Worker -> Settings -> Variables -> KV Namespace Bindings。添加一个变量名为 `MirroTalk` 的绑定，并创建一个新的命名空间。
5.  **设置 Webhook**：部署完成后，访问以下链接注册 Webhook：`https://你的-worker-子域名.workers.dev/registerWebhook`
